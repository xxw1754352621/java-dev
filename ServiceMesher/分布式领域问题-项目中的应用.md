# 分布式领域问题-项目中的应用

## 分布式存储理论

CAP : Consistency Availability Partition tolerance 只能满足其二

BASE :Basically Available（基本可用）Soft state（柔性状态）Eventually consistent（最终一致）

Quorum NRW

## 分布式存储模型

Consistent hash,(去中心化 ) -->memcahed
B+ tree (实时,随机) -->mongodb
LSM tree, (批量 顺序) -->hbase



## 分布式事务

### CAP原则

一致性模型，主要有三种：

1. **Strong Consistency**（强一致性）：新的数据一旦写入，在任意副本任意时刻都能读到新值。比如：文件系统，RDBMS，Azure Table都是强一致性的。
2. **Week Consistency**（弱一致性）：不同副本上的值有新有旧，需要应用方做更多的工作获取最新值。比如Dynamo。
3. **Evantual Consistency**（最终一致性）：一旦更新成功，各副本的数据最终将达到一致。

#### 分布式事务解决方案

- **两阶段提交（2PC）**、**三阶段提交（3PC）**、**补偿事务（TCC）**等虽然能实现数据的强一致，但是都是通过牺牲可用性来实现。

### [BASE理论](https://juejin.im/post/5c7cd6eee51d457c042d4b52)

**BASE理论**是对**CAP原则**中一致性和可用性权衡的结果：**Basically Available（基本可用）、Soft state（软状态）和Eventually consistent（最终一致性）**。BASE理论，其来源于对大规模互联网系统分布式实践的总结，是基于**CAP原则**逐步演化而来的。其最核心思想是：即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。
 **基本可用**
 基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性，这不等价于系统不可用。
 **软状态**
 软状态指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时
 **最终一致性**
 最终一致性强调的是所有的数据副本，在经过一段时间的同步之后，最终都能够达到一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。

总的来说，**BASE理论**面向的是大型高可用可扩展的分布式系统，和传统的事物**ACID特性**是相反的，它完全不同于**ACID**的强一致性模型，而是通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状态。同时，在实际的分布式场景中，不同业务单元和组件对数据一致性的要求是不同的，因此在具体的分布式系统架构设计过程中，ACID特性和BASE理论往往又会结合在一起。



 



## 原则与目标

原则： kiss
 来源 : unix 设计哲学
 产品 -->微信摇一摇 苹果新手入门
 技术 --->个性化推荐

目标: RAS
RAS: Reliability, Availability, Scalability 高可靠，高可用，高扩展

## 编码复杂度
   
是否侵入式

## 项目中的应用

### 分布式事务应用

项目1：pds-gos

业务描述：

- 强一致性
  - gos系统下单，oper系统计费
    - oper计费失败，则两边都回滚
    - oper计费成功
      - gos保存下单数据成功
      - gos保存下单数据失败，oper事务提交成功，目前gos没有做保证下单成功处理
        - 方案
          - 1.原有基础上，数据保存失败
            - 最大努力重试+mongodb等落地+钉钉通知+**人工接入**
          - 2.分布式事务解决方案的引入
            - 最终一致性

流程图：



项目2：pds-hwms

业务描述：

- 包裹更新和轨迹回传到上游

流程图：



### 分布式事务应用

项目1：pds-gos

业务描述：（同城揽派）

- 业务性能要求高，目前并发量不大，日均下单量 30
- 强一致性
  - gos系统下单，oper系统计费
    - oper计费失败，则两边都回滚
    - oper计费成功
      - gos保存下单数据成功
      - gos保存下单数据失败，oper事务提交成功，目前gos没有做保证下单成功处理
        - 方案
          - 1.原有基础上，数据保存失败
            - 最大努力重试+mongodb等落地+钉钉通知+**人工接入**
          - 2.分布式事务解决方案的引入
            - 最终一致性

流程图：

![avatar](https://github.com/xxw1754352621/java-dev/blob/master/img/order.jpg)

项目2：pkg  和 hwms

业务描述：（末端派送）

- 业务性能要求高，仓库功能日均操作量为2万单，集中时间操作
- hwms仓内作业 - 包裹上架
  - hwms包裹更新，pkg包裹更新 -> 插入操作记录 -> 轨迹回传上游
    - hwms包裹更新失败，停止执行
    - hwms包裹更新成功
      - pkg操作成功
      - pkg操作失败
        - 方案
          - pkg本地事务回滚，同时放回队列，系统重试失败后 -> 人工介入
          - 其他

流程图：![avatar](https://github.com/xxw1754352621/java-dev/blob/master/img/warehouse.jpg)

### 分布式中间件应用

项目3：pkg 到 hwms

业务描述：（末端派送）

- 业务性能要求不高，日均2万，集中时间预报
- 第三方数据预报到末端系统（pkg），末端系统处理后，通过MQ预报到hwms
  - 中间件投递可靠性处理（ACK等后置处理）
  - 中间件消费ACK处理

流程图：

### 分布式存储应用

项目4：pickup

业务描述：（末端揽收）

- 失败的预报数据保存到mongodb
  - 读写策略修改，无法等待服务器ACK，确保数据百分百落地
    - 后置重复保存处理

流程图：


[^1]: [分布式系统架构](http://book.mixu.net/distsys/)
[^2]: [分布式系统书籍](http://book.mixu.net/distsys/)
[^3]: [分布式经典论文](https://www.zhihu.com/question/30026369)

